\documentclass[12pt]{article}
\usepackage[]{graphicx}
\usepackage[]{color}
%% use \xspace to allow for space after a macro as necessary
\usepackage{xspace}
\usepackage[top=1in, bottom=1in, left=1.25in, right=1.25in]{geometry}
\usepackage{pdfpages}
%% maxwidth is the original width if it is less than linewidth
%% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{commentcol}{rgb}{0.345, 0.345, 0.945}
\newcommand{\comment}[1]{\textcolor{commentcol}{[[#1]]}}%

% general-purpose mathrm macros
\newcommand{\symsub}[2]{\ensuremath{#1_{\tiny \mathrm{#2}}}\xspace}
\newcommand{\mrm}[1]{\ensuremath{\mathrm{#1}}
\xspace}

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{randomcolor}{rgb}{.97, .27, .67}
\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
\usepackage[sort]{natbib}
\usepackage{amsmath}
\usepackage{alltt}
\usepackage{hyperref}
\usepackage[utf8]{inputenc} % for accented characters
%% stuff for editing
%\usepackage[markup=nocolor,addedmarkup=bf,deletedmarkup=sout]{changes}
%% to suppress notes & comments: \usepackage[final]{changes}
\usepackage[backgroundcolor=lightgray]{todonotes}
\usepackage{setspace}
\bibliographystyle{chicago}
\title{Need a good title.}
\author{Michael Li and Ben Bolker}
\date{\today}

\providecommand{\keywords}[1]{\textbf{\textit{Keywords:}} #1}
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}
\newcommand{\dbic}{\ensuremath \Delta \textrm{BIC}}

%% don't typeset BMB comments
\newcommand{\bmbhide}[1]{}
\newcommand{\bmb}[1]{{\color{blue} BB: #1}}

\newcommand{\fref}[1]{Figure~\ref{fig:#1}}

\newcommand{\ml}[1]{{\color{red} ML: #1}}

\newcommand{\add}[1]{{\color{blue} ADD: #1}}

%\SweaveOpts{concordance=TRUE}
%\SweaveOpts{concordance=TRUE}
\maketitle

\doublespacing

\keywords{phyloglmm ... }

\section{Introduction}
\ml{I will fill in appropriate citation later}


Given a phylogenetic tree, phylogenetic models aim to find parsimonious methods that can be used to link ecological phenomena with evolutionary processes that generate species and exhibit in their traits.
Ecologist have long considered the effects of species functional traits and environmental conditions on their phenotypic traits and also incorportating historical relationships of species.
Decades of work have created various different methods that enables researchers to analyze species relativeness problems for different types of data and questions.
But many challenges remain.
In particular, incorportating phylogenetic signals in high dimensional systems is always challenging, especially with large phylogenies where computation powers are limited.
In such case, researchers often use simpler models with minimal phylogenetic signals limiting at the individuals level and neglect additional phylogenetic signals present in the system.

Recent years, researchers have begun to incorportate phylogenetic-based methods in various modelling applications \ml{cite}.
The most widely used statistical method to model related species data that accounts for the phylogenetic structure is the \textit{phylogenetic regression} via independent constrast \ml{cite Felsenstein 1985} and further generalizations to generalized least square regression (PGLS) and generalized linear mixed models (PGLMM) to allow for different models of trait evolution \ml{or types of response?}. 
Despite the choice of modelling strageties, there are many limitations in the current state of art of statistical phylogenetic analysis.
There are a handful of studies discussing the importance of incorportating phylogenetic signals but relatively few systematically look at comparative performance of comparative phylogenetic methods. 

In this paper, we propose an alternative, yet straightforward but little-used method of constructing phylogenetic correlations directly from phylogenetic tree by summing the evolutionary changes that occurred on all of the branches in the phylogeny in its past.
We apply relatively simple phylogenetic comparative approaches to data from simulated phylogenies that incorportate various complexity of phylogenetic signals in the model. 
We compare model approaches and explore various complex modelling strategies in the mixed model framework and a flexible platform for researches to explore biologically interesting questions.

We also compare three different R packages: nlme, pez, and lme4. 
\ml{Not sure if we should include the line "we are not using Bayesian approaches" here but defintely in the discussions.}

\section{Materials and Methods}

The typical phylogenetic regression is of the form:
\begin{align}
y & = XB + \epsilon \\
\epsilon & \sim MVN(0,\sigma^{2}C),
\label{eq:gls}
\end{align}
where $y$ is an $n \times 1$ vector of measureable response phenotypic trait; $X$ is an $n \times (m + 1)$ model matrix containing 1's in the first column and the $m$ independment variable (traits); $B$ is an $m + 1$ coefficient vector; $\epsilon$ is the residual error and assumed to be multivariate normally distributed with a variance-covariance matrix given by $\sigma^{2}_{\epsilon}C$ in which $C$ is an $n \times n$ matrix of the phylogenetic correlation (PC).

% More recently, researchers use linear mixed model and generalized linear mixed model framework to model complex systems with phylogenetic structures.
%\ml{Why? Data type, interactions, random effects, etc... Need to really explain random effects here. Alternatively, we can drop this line and write this...}
An alternative modelling approach is to use linear mixed effects modelling framework.
The typical linear mixed model has the form:
\begin{align}
Y & \sim F(\mu) \\
g(\mu) & = XB + Zb + \epsilon_{mm} \\
\epsilon_{mm} & \sim MVN(0,\sigma^2)
\end{align}
where $Z$ is an $n \times (m+1)$ model matrix for the $(m+1)$ -- dimensional vector-valued $m$ independment variables; $\epsilon_{mm}$ is the residual error and assumed to be multivariate normally distributed with a variance-covariance matrix given by $\sigma_{2}I$.
Analogously, the phylogenetic regression given by (1) can be represented in the mixed model framework by constraining $\epsilon_{mm} = 0$ and $Z=Z^{c}$ where the PC is incorportated in the random effect matrix. 

\subsection{Phylogenetic Tree Transformation}
The standard problem of phylogenetic comparative methods is to analyze relationships among data where the observations are gathered from nodes (usually tips) of a phylogenetic tree.
Phylogenetic independent constrasts is a generalization of the paired comparisons method where contrasts are taken for each bifurcation (nodes) in a phylogenetic tree. 
Assuming that traits evolve independently in each lineage following speciation, then the trait divergences that occur at one node are independent of divergence at other nodes.  

An alternative approach is to model the phylogenetic correlation as a \textit{gaussian process}. 
In particular, suppose that the evolutionary process is a Brownian motion, which means the evolution of a continuous trait is a random walk and daughter species after speciation are all independent.  
In that case, the phylogenetic variability of a particular observation can be written as the sum of the evolutionary changes that occurred on all of the branches in the phylogeny in its past. 
Thus, the evolutionary history for each species can be model with a sequence of independent errors, rather than having to impose a correlation structure on the random effects. 


The random-effect model matrix $Z$ can be decomposed into term-wise model matrix $Z_{i}$ as described in \ml{in text citation lme4}.
Thus, the phylogenetic correlated random-effect matrix $Z^{C}_{i}$ is

\begin{equation}
Z^{C}_{i} = (BS^{T}_{i}J^{T}_{i} \ast X^{T}_{i})^{T},
\end{equation}

\ml{double check if $l and p$ are the same with lme4}

where $\ast$ is the Khatri-Rao product, $BS_{i}$ is an $l_{i} \times b_{i}$ matrix of species--branch relations; $J_{i}$ the indicator matrix of grouping factors indices matrix size $n \times l_{i}$; $X_{i}$ is the raw random effects model matrix size $n \times p_{i}$.

\ml{double kronecker for interactions}



\subsection{Simulations}

% \begin{table}
% \begin{center}
\begin{tabular}{|c|c|c|}
\hline
Type of RE	& Formula	& Platform	\\
\hline

Single site intercept	  &	1 $\mid$ sp	& gls, lme4 \\
Single site intercept and uncorrelated slopes		&  1 $\mid$ sp + trait $\mid$ sp		& lme4 \\
Single site intercept and correlated slopes 			& 1 + trait $\mid$ sp					& lme4 \\
\hline
Multiple site intercept 									&  1 $\mid$ sp 						& pez, lme4 \\
Multiple site intercept and uncorrelated slopes 	&  1 $\mid$ sp + trait $\mid$ sp 		& pez, lme4 \\
Multiple site intercept and correlated slopes 	& 	1 + trait $\mid$ sp					& lme4 \\
\hline
\end{tabular}
% \vspace{1in}
% ditto with site interaction								& ditto above $\mid$ sp:site		& ditto above \\
% \end{center}
% \end{table}

The simulation models is based on glmm framework described in \ml{eq labels 3-5}.   
To construct the simulation model, let $n$ be the number of species distributed among $m$ sites.
Let $Y$ be the $mn \times 1$ vectors of response trait.  
We generate test data using three different $n$ (20, 100, 500) and two different $m$ (1, 20) using a simple glmm framework that varies in complexity in random effect described in \ml{Table 1, macro this with labels}. 
We also extend the multiple site models described in \ml{Table 1} with species by site interaction random effects. 
All simulations and fits were performed with R. 

\subsection{Model Fitting}



\section{Results}



\section{Discussion}

\section{Conclusion}

\end{document}

